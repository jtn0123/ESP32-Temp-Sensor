<!DOCTYPE html>
<html>
<head>
    <title>Final Validation Fixes Test</title>
    <style>
        body { 
            font-family: monospace; 
            padding: 20px;
            background: #f0f0f0;
        }
        #canvas { 
            border: 2px solid #333;
            background: white;
            display: block;
            margin: 20px 0;
            image-rendering: pixelated;
        }
        .controls {
            margin: 10px 0;
        }
        button, label {
            padding: 5px 10px;
            margin-right: 10px;
            cursor: pointer;
        }
        .test-result {
            margin: 5px 0;
            padding: 5px 10px;
            border-left: 3px solid #ddd;
        }
        .test-result.pass { 
            border-left-color: #4CAF50; 
            background: #E8F5E9;
        }
        .test-result.fail { 
            border-left-color: #F44336; 
            background: #FFEBEE;
        }
        .status {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Final Validation Fixes - Comprehensive Test</h1>
    
    <canvas id="canvas" width="250" height="122"></canvas>
    
    <div class="controls">
        <label>
            <input type="checkbox" id="showRects">
            Show Geometry Overlays
        </label>
        <label>
            <input type="checkbox" id="showLabels">
            Show Labels
        </label>
        <label>
            <input type="checkbox" id="validationEnabled" checked>
            Enable Validation
        </label>
    </div>
    
    <div class="controls">
        <button id="runAllTests">Run All Tests</button>
        <button id="toggleGeometry">Toggle Geometry Multiple Times</button>
    </div>
    
    <div id="testResults"></div>
    <div id="status" class="status">Ready to test</div>
    
    <script src="ui_generated.js"></script>
    <script src="sim.js"></script>
    <script>
        const statusEl = document.getElementById('status');
        const resultsEl = document.getElementById('testResults');
        
        function log(msg, isError = false) {
            const div = document.createElement('div');
            div.className = isError ? 'test-result fail' : 'test-result pass';
            div.textContent = msg;
            resultsEl.appendChild(div);
        }
        
        function clearResults() {
            resultsEl.innerHTML = '';
        }
        
        function checkCanvasForWhiteLines() {
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, 250, 122);
            const data = imageData.data;
            
            // Check specific areas where white lines were appearing
            // Around temperature display areas
            let whiteLineCount = 0;
            
            // Check vertical divider area (x=125)
            for (let y = 36; y < 64; y++) {
                for (let x = 124; x < 127; x++) {
                    const idx = (y * 250 + x) * 4;
                    // Count pixels that are very light (almost white) but not pure white
                    if (data[idx] > 200 && data[idx] < 255) {
                        whiteLineCount++;
                    }
                }
            }
            
            return whiteLineCount;
        }
        
        async function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        async function runTests() {
            clearResults();
            statusEl.textContent = 'Running tests...';
            
            // Test 1: Initial load should have no OUT_ROW validation errors
            log('Test 1: Checking initial load...');
            window.draw({
                room_name: 'Test Room',
                inside_temp_f: 72.5,
                outside_temp_f: 68.4,
                outside_hum_pct: 53,
                weather_short: 'cloudy',
                wind_mps: 1.88,
                pressure_hpa: 1013.2
            });
            
            await sleep(200);
            
            const issues = window.validationIssues || [];
            const outRowErrors = issues.filter(i => 
                i.region && i.region.startsWith('OUT_ROW') && 
                (i.severity === 'error' || i.severity === 'warning')
            );
            
            if (outRowErrors.length === 0) {
                log('✓ No OUT_ROW validation errors on initial load');
            } else {
                log(`✗ Found ${outRowErrors.length} OUT_ROW validation errors`, true);
                outRowErrors.forEach(e => {
                    log(`  - ${e.region}: ${e.description}`, true);
                });
            }
            
            // Test 2: Toggle geometry on and off
            log('\nTest 2: Toggling geometry overlays...');
            const showRectsEl = document.getElementById('showRects');
            
            // Turn on
            showRectsEl.checked = true;
            showRectsEl.dispatchEvent(new Event('change'));
            await sleep(100);
            
            // Turn off
            showRectsEl.checked = false;
            showRectsEl.dispatchEvent(new Event('change'));
            await sleep(100);
            
            const whiteLines = checkCanvasForWhiteLines();
            if (whiteLines < 10) {
                log('✓ No significant white lines after toggling geometry');
            } else {
                log(`✗ Found ${whiteLines} white line pixels after toggling`, true);
            }
            
            // Test 3: Wind speed display
            log('\nTest 3: Testing wind speed display...');
            window.draw({
                wind_mps: 44.7, // 100 mph
                outside_hum_pct: 53
            });
            
            await sleep(100);
            
            const windIssues = (window.validationIssues || []).filter(i => 
                i.region === 'OUT_ROW2_R' && i.type === 'text_overflow'
            );
            
            if (windIssues.length === 0) {
                log('✓ No overflow for wind speed (100 mph)');
            } else {
                log('✗ Wind speed text overflow detected', true);
            }
            
            // Test 4: Multiple geometry toggles
            log('\nTest 4: Multiple geometry toggles...');
            let toggleSuccess = true;
            
            for (let i = 0; i < 5; i++) {
                showRectsEl.checked = !showRectsEl.checked;
                showRectsEl.dispatchEvent(new Event('change'));
                await sleep(50);
            }
            
            // Final state: geometry should be off
            showRectsEl.checked = false;
            showRectsEl.dispatchEvent(new Event('change'));
            await sleep(100);
            
            const finalWhiteLines = checkCanvasForWhiteLines();
            if (finalWhiteLines < 10) {
                log('✓ Display clean after multiple toggles');
            } else {
                log(`✗ White lines persist after multiple toggles (${finalWhiteLines} pixels)`, true);
            }
            
            // Test 5: Validation overlay not showing for OUT_ROW
            log('\nTest 5: Checking validation overlays...');
            
            // Ensure validation is on and geometry is off
            document.getElementById('validationEnabled').checked = true;
            showRectsEl.checked = false;
            
            // Draw data that would normally cause issues
            window.draw({
                weather_short: '',  // Empty weather
                wind_mps: null      // No wind data
            });
            
            await sleep(100);
            
            // Check if validation overlay is drawing thick borders
            // This is harder to test programmatically, but we can check the issues list
            const emptyDataIssues = (window.validationIssues || []).filter(i => 
                i.region && i.region.startsWith('OUT_ROW')
            );
            
            log(`Found ${emptyDataIssues.length} OUT_ROW issues (info level acceptable)`);
            
            // Count actual error/warning level issues
            const seriousIssues = emptyDataIssues.filter(i => 
                i.severity === 'error' || i.severity === 'warning'
            );
            
            if (seriousIssues.length === 0) {
                log('✓ No error/warning level issues for OUT_ROW regions');
            } else {
                log(`✗ Found ${seriousIssues.length} serious OUT_ROW issues`, true);
            }
            
            statusEl.textContent = 'Tests complete!';
        }
        
        // Wait for everything to load
        window.addEventListener('load', () => {
            statusEl.textContent = 'Ready to test. Click "Run All Tests" to begin.';
            
            // Initial draw
            window.draw({
                room_name: 'Test Room',
                inside_temp_f: 72.5,
                outside_temp_f: 68.4,
                wind_mps: 1.88,
                pressure_hpa: 1013.2
            });
            
            document.getElementById('runAllTests').addEventListener('click', runTests);
            
            document.getElementById('toggleGeometry').addEventListener('click', async () => {
                statusEl.textContent = 'Toggling geometry multiple times...';
                const showRectsEl = document.getElementById('showRects');
                
                for (let i = 0; i < 10; i++) {
                    showRectsEl.checked = !showRectsEl.checked;
                    showRectsEl.dispatchEvent(new Event('change'));
                    await sleep(100);
                }
                
                statusEl.textContent = 'Toggle test complete. Check for white lines.';
            });
        });
    </script>
</body>
</html>