<!DOCTYPE html>
<html>
<head>
  <title>Temperature Overflow Validation Test</title>
  <meta charset="utf-8">
  <style>
    body { font-family: monospace; background: #f0f0f0; padding: 20px; }
    canvas { border: 1px solid #999; background: white; }
    .test-controls { margin: 20px 0; }
    .test-result { margin: 10px 0; padding: 10px; background: white; border-radius: 4px; }
    .pass { border-left: 4px solid green; }
    .fail { border-left: 4px solid red; }
    .warning { border-left: 4px solid orange; }
  </style>
</head>
<body>
  <h1>Temperature Overflow Validation Test</h1>
  
  <canvas id="canvas" width="250" height="122"></canvas>
  
  <div class="test-controls">
    <button onclick="runTests()">Run All Tests</button>
    <button onclick="clearResults()">Clear Results</button>
  </div>
  
  <div id="results"></div>
  
  <script src="ui_spec.js"></script>
  <script src="sim.js"></script>
  <script>
    const resultsDiv = document.getElementById('results');
    
    function addResult(testName, passed, details) {
      const div = document.createElement('div');
      div.className = `test-result ${passed ? 'pass' : details.includes('warning') ? 'warning' : 'fail'}`;
      div.innerHTML = `
        <strong>${testName}:</strong> ${passed ? '✓ PASS' : details.includes('warning') ? '⚠ WARNING' : '✗ FAIL'}<br>
        <small>${details}</small>
      `;
      resultsDiv.appendChild(div);
    }
    
    function clearResults() {
      resultsDiv.innerHTML = '';
    }
    
    async function runTests() {
      clearResults();
      
      // Enable validation
      window.validationEnabled = true;
      
      // Test 1: Normal temperature values
      addResult('Test 1: Normal temperatures', true, 'Testing normal temperature display...');
      await window.draw({
        room_name: 'Test Room',
        inside_temp_f: 72.5,
        outside_temp_f: 68.4,
        inside_hum_pct: 47,
        outside_hum_pct: 53
      });
      window.runValidation();
      
      let tempOverflows = window.validationIssues.filter(i => 
        (i.region === 'INSIDE_TEMP_INNER' || i.region === 'OUT_TEMP_INNER') && 
        i.type === 'text_overflow'
      );
      
      if (tempOverflows.length > 0) {
        addResult('Normal temp validation', false, 
          `Found ${tempOverflows.length} overflow(s): ${tempOverflows.map(o => o.description).join(', ')}`);
      } else {
        addResult('Normal temp validation', true, 'No overflows detected for normal temperatures');
      }
      
      // Test 2: Extreme negative temperatures
      await window.draw({
        room_name: 'Test Room',
        inside_temp_f: -10.2,
        outside_temp_f: -20.5,
        inside_hum_pct: 47,
        outside_hum_pct: 53
      });
      window.runValidation();
      
      tempOverflows = window.validationIssues.filter(i => 
        (i.region === 'INSIDE_TEMP_INNER' || i.region === 'OUT_TEMP_INNER') && 
        i.type === 'text_overflow'
      );
      
      if (tempOverflows.length > 0) {
        addResult('Negative temp validation', false, 
          `Found ${tempOverflows.length} overflow(s): ${tempOverflows.map(o => o.description).join(', ')}`);
      } else {
        addResult('Negative temp validation', true, 'No overflows detected for negative temperatures');
      }
      
      // Test 3: Three-digit temperatures
      await window.draw({
        room_name: 'Test Room',
        inside_temp_f: 109.9,
        outside_temp_f: 100.5,
        inside_hum_pct: 47,
        outside_hum_pct: 53
      });
      window.runValidation();
      
      tempOverflows = window.validationIssues.filter(i => 
        (i.region === 'INSIDE_TEMP_INNER' || i.region === 'OUT_TEMP_INNER') && 
        i.type === 'text_overflow'
      );
      
      if (tempOverflows.length > 0) {
        addResult('Three-digit temp validation', tempOverflows.length <= 2, 
          `Found ${tempOverflows.length} overflow(s): ${tempOverflows.map(o => o.description).join(', ')}`);
      } else {
        addResult('Three-digit temp validation', true, 'No overflows detected for three-digit temperatures');
      }
      
      // Test 4: Check if validation is now detecting temperature overflows
      await window.draw({
        room_name: 'Test Room',
        inside_temp_f: -999.9,  // Extremely wide value
        outside_temp_f: 999.9,   // Extremely wide value
        inside_hum_pct: 47,
        outside_hum_pct: 53
      });
      window.runValidation();
      
      tempOverflows = window.validationIssues.filter(i => 
        (i.region === 'INSIDE_TEMP_INNER' || i.region === 'OUT_TEMP_INNER') && 
        i.type === 'text_overflow'
      );
      
      if (tempOverflows.length > 0) {
        addResult('Extreme overflow detection', true, 
          `Correctly detected ${tempOverflows.length} overflow(s) for extreme values`);
      } else {
        addResult('Extreme overflow detection', false, 
          'Failed to detect overflows for extreme temperature values');
      }
      
      // Test 5: Check that regions are properly sized
      const insideInner = window.GJSON.rects.INSIDE_TEMP_INNER;
      const outInner = window.GJSON.rects.OUT_TEMP_INNER;
      
      if (insideInner && outInner) {
        const insideWidth = insideInner[2];
        const outWidth = outInner[2];
        addResult('Region sizing check', true, 
          `INSIDE_TEMP_INNER width: ${insideWidth}px, OUT_TEMP_INNER width: ${outWidth}px`);
      } else {
        addResult('Region sizing check', false, 
          'Inner temperature regions not found in GJSON.rects');
      }
      
      // Summary
      const totalIssues = window.validationIssues.length;
      const criticalIssues = window.validationIssues.filter(i => i.severity === 'critical').length;
      const errorIssues = window.validationIssues.filter(i => i.severity === 'error').length;
      const warningIssues = window.validationIssues.filter(i => i.severity === 'warning').length;
      
      addResult('Validation Summary', true, 
        `Total: ${totalIssues} issues (Critical: ${criticalIssues}, Errors: ${errorIssues}, Warnings: ${warningIssues})`);
    }
    
    // Run tests on load
    window.addEventListener('load', () => {
      setTimeout(runTests, 1000);
    });
  </script>
</body>
</html>