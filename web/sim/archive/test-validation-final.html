<!DOCTYPE html>
<html>
<head>
  <title>Validation Fixes Test</title>
  <meta charset="utf-8">
  <style>
    body { font-family: monospace; background: #f0f0f0; padding: 20px; }
    canvas { border: 1px solid #999; background: white; }
    .summary { margin: 20px 0; padding: 15px; background: white; border-radius: 4px; }
    .pass { color: green; font-weight: bold; }
    .fail { color: red; font-weight: bold; }
    .warning { color: orange; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Temperature Region Validation Test</h1>
  
  <canvas id="canvas" width="250" height="122"></canvas>
  
  <div class="summary" id="summary">
    <h3>Test Results:</h3>
    <div id="results">Loading...</div>
  </div>
  
  <script src="ui_spec.js"></script>
  <script src="sim.js"></script>
  <script>
    async function runTest() {
      // Wait for initialization
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Enable validation
      window.validationEnabled = true;
      
      // Draw with typical values
      await window.draw({
        room_name: 'Office',
        time_hhmm: '10:32',
        inside_temp_f: 72.5,
        outside_temp_f: 68.4,
        inside_hum_pct: 47,
        outside_hum_pct: 53,
        pressure_hpa: 1013.2,
        weather: 'cloudy',
        battery_percent: 76,
        battery_voltage: 4.01,
        fw_version: '1.03'
      });
      
      // Run validation
      window.runValidation();
      
      // Check results
      const results = document.getElementById('results');
      let html = '';
      
      // Check for temperature overflow issues
      const tempOverflows = window.validationIssues.filter(i => 
        (i.region === 'INSIDE_TEMP_INNER' || i.region === 'OUT_TEMP_INNER' || 
         i.region === 'INSIDE_TEMP' || i.region === 'OUT_TEMP') && 
        (i.type === 'text_overflow' || i.type === 'text_overflow_vertical')
      );
      
      if (tempOverflows.length === 0) {
        html += '<p class="pass">‚úì No temperature overflow issues detected</p>';
      } else {
        html += '<p class="fail">‚úó Temperature overflow issues found:</p>';
        html += '<ul>';
        tempOverflows.forEach(issue => {
          html += `<li class="${issue.severity}">${issue.description}</li>`;
        });
        html += '</ul>';
      }
      
      // Check region dimensions
      const insideInner = window.GJSON.rects.INSIDE_TEMP_INNER;
      const outInner = window.GJSON.rects.OUT_TEMP_INNER;
      
      if (insideInner && outInner) {
        html += '<h4>Region Dimensions:</h4>';
        html += `<p>INSIDE_TEMP_INNER: x=${insideInner[0]}, y=${insideInner[1]}, w=${insideInner[2]}, h=${insideInner[3]}</p>`;
        html += `<p>OUT_TEMP_INNER: x=${outInner[0]}, y=${outInner[1]}, w=${outInner[2]}, h=${outInner[3]}</p>`;
        
        // Check if height is sufficient for 22px font
        if (insideInner[3] >= 16 && outInner[3] >= 16) {
          html += '<p class="pass">‚úì Region heights are sufficient for font size</p>';
        } else {
          html += '<p class="warning">‚ö† Region heights may be tight for font size</p>';
        }
      }
      
      // Check font size
      const fontBig = window.GJSON.fonts?.tokens?.big?.px || 22;
      html += `<p>Temperature font size: ${fontBig}px</p>`;
      
      // Overall summary
      const totalIssues = window.validationIssues.length;
      const critical = window.validationIssues.filter(i => i.severity === 'critical').length;
      const errors = window.validationIssues.filter(i => i.severity === 'error').length;
      const warnings = window.validationIssues.filter(i => i.severity === 'warning').length;
      
      html += '<h4>Overall Validation Summary:</h4>';
      html += `<p>Total issues: ${totalIssues} (Critical: ${critical}, Errors: ${errors}, Warnings: ${warnings})</p>`;
      
      // List all validation issues
      if (window.validationIssues.length > 0) {
        html += '<h4>All Issues:</h4>';
        html += '<ul>';
        window.validationIssues.forEach(issue => {
          const icon = issue.severity === 'critical' ? 'üî¥' : 
                       issue.severity === 'error' ? 'üü†' : 
                       issue.severity === 'warning' ? 'üü°' : '‚ÑπÔ∏è';
          html += `<li>${icon} [${issue.region || 'general'}] ${issue.type}: ${issue.description}</li>`;
        });
        html += '</ul>';
      }
      
      results.innerHTML = html;
    }
    
    // Run test on load
    window.addEventListener('load', () => {
      setTimeout(runTest, 1000);
    });
  </script>
</body>
</html>